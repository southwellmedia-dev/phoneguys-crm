<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Real-time Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { margin: 5px; padding: 10px 15px; }
        #console { background: #000; color: #0f0; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Customer Real-time Integration Test</h1>
    
    <div class="test-section">
        <h3>Test Steps:</h3>
        <ol>
            <li>Open browser console (F12)</li>
            <li>Navigate to http://localhost:3000/customers in another tab</li>
            <li>Click the buttons below to simulate customer changes</li>
            <li>Watch for real-time updates in the customers page</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Test Actions:</h3>
        <button onclick="testCreateCustomer()">Create Test Customer</button>
        <button onclick="testUpdateCustomer()">Update Last Customer</button>
        <button onclick="testDeleteCustomer()">Delete Last Customer</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="test-section">
        <h3>Console Output:</h3>
        <div id="console"></div>
    </div>

    <script>
        let lastCustomerId = null;
        
        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        async function testCreateCustomer() {
            log('üß™ Testing customer creation...');
            
            const testCustomer = {
                name: `Test Customer ${Date.now()}`,
                email: `test-${Date.now()}@example.com`,
                phone: `555-${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`,
                address: '123 Test Street, Test City',
                notes: 'Created via real-time test'
            };

            try {
                const response = await fetch('http://localhost:3000/api/customers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testCustomer),
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    lastCustomerId = result.id || result.data?.id;
                    log(`‚úÖ Customer created successfully! ID: ${lastCustomerId}`);
                    log(`   Name: ${result.name || result.data?.name}`);
                    log(`   Check the customers page for real-time update`);
                } else {
                    const error = await response.text();
                    log(`‚ùå Failed to create customer: ${response.status} ${response.statusText}`);
                    log(`   Error: ${error}`);
                }
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`);
            }
        }

        async function testUpdateCustomer() {
            if (!lastCustomerId) {
                log('‚ùå No customer to update. Create a customer first.');
                return;
            }

            log(`üß™ Testing customer update for ID: ${lastCustomerId}...`);
            
            const updateData = {
                name: `Updated Customer ${Date.now()}`,
                notes: `Updated via real-time test at ${new Date().toLocaleString()}`
            };

            try {
                const response = await fetch(`http://localhost:3000/api/customers/${lastCustomerId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData),
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Customer updated successfully!`);
                    log(`   New name: ${result.name || result.data?.name}`);
                    log(`   Check the customers page for real-time update`);
                } else {
                    const error = await response.text();
                    log(`‚ùå Failed to update customer: ${response.status} ${response.statusText}`);
                    log(`   Error: ${error}`);
                }
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`);
            }
        }

        async function testDeleteCustomer() {
            if (!lastCustomerId) {
                log('‚ùå No customer to delete. Create a customer first.');
                return;
            }

            if (!confirm('Are you sure you want to delete the test customer?')) {
                log('üö´ Delete cancelled by user.');
                return;
            }

            log(`üß™ Testing customer deletion for ID: ${lastCustomerId}...`);

            try {
                const response = await fetch(`http://localhost:3000/api/customers/${lastCustomerId}/cascade-delete`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    log(`‚úÖ Customer deleted successfully!`);
                    log(`   Check the customers page for real-time update`);
                    lastCustomerId = null;
                } else {
                    const error = await response.text();
                    log(`‚ùå Failed to delete customer: ${response.status} ${response.statusText}`);
                    log(`   Error: ${error}`);
                }
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`);
            }
        }

        // Initial log
        log('üöÄ Customer Real-time Test Ready');
        log('Open http://localhost:3000/customers in another tab, then run tests here.');
    </script>
</body>
</html>